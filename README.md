# An Intro to Malware Analysis

Have you ever wanted to learn how to analyze malware, determine malware attribution, and learn more about how others defend against malware? Then this guide is for you!

Topics covered in this guide:

- How to set up a Sandbox environment
- How to determine malware attribution
- What are YARA rules
- How to collect useful malware information for generating YARA rules
- AI applications in defending against malware

Please note that this guide assumes readers already have some baseline knowledge in C, Linux, virtual machines, and Ghidra. If you as a reader are unfamiliar with any of these topics, I suggest you look into them before reading more about this guide. I have a tutorial for how to use Ghidra [here](https://sites.google.com/view/ghidra-reverse-engineering/home#h.s1qs2m8gk4s9).

## Setting up a Sandboxed Environment

In order to safely and efficiently analyze our sample malware, we need to set up a **sandboxed environment**. A sandboxed environment is a virtual environment that allows you to safely run and analyze potentially malicious software, without risking damage to your host machine. To set up a sandboxed environment, there are a few key steps you need to follow!

### Step 1: Install Oracle VirtualBox

For the purpose of this guide, we will be using VirtualBox. If you have already installed VirtualBox ***without Guest Additions****, you can skip this step (by default, installations do not come with Guest Additions).

If you haven’t installed VirtualBox already, you can do so [here](https://www.virtualbox.org/wiki/Downloads). You’ll want to install it on your host machine, so install the version that works with your host OS. Feel free to use the default installation settings, but do **not** install VirtualBox Guest Additions.*

**Make sure you do not install VirtualBox Guest Additions, as they could put your host machine at risk. If you have already installed them, you should uninstall VirtualBox and reinstall the program without Guest Additions. To check if you have installed them, run any virtual machine and use `Host Key + N` to get to performance settings. From there, select the Runtime Information Tab and view the Guest Additions information. If the guest additions are not installed, then it should report “Guest Additions: Not Detected”, otherwise they have been installed.* 

### Step 2: Install and Set Up REMnux

Next, we’ll download REMnux, a Linux toolkit for analyzing malware. We will download the VirtualBox OVA file from [here](https://docs.remnux.org/install-distro/get-virtual-appliance).

Once we have installed the OVA file, we’ll want to import it into VirtualBox. We can import it by opening the VirtualBox application and going to `File > Import Appliance` (Ctrl+i). 

From there, a window will launch that will look similar to the following (minus the base folder and the name). Feel free to keep these settings for now, the RAM usage should be okay. 

![malwareguide1.png](img/malwareguide1.png)

- Note: if it asks you to make a hard drive, feel free to make a Virtual Disk Image (VDI) of ~60GB. This can be dynamically sized, since we are only performing a static analysis.

Once you’re ready, click `Import` to start the import process. It should take a few minutes, so sit back and grab a coffee.  

After importing the file, we’ll want open the virtual machine by pressing `Start` to launch the window. The default credentials for sign-on is username: `remnux`, password: `malware`. After signing on, it’s good practice to change the credentials from their default setting.

### Step 3: Install Relevant Programs

After setting up REMnux, we’ll want to install the following programs onto our REMnux virtual machine:

- Ghidra
    - Follow the installation guide [here](https://sites.google.com/view/ghidra-reverse-engineering/home?authuser=0#h.4bs06m50ro54) to set up Ghidra for Linux distributions.
- VSCode or your favorite IDE
    - Install any extensions you want before moving onto the next steps!
    - VSCode is also great for writing notes about the system, if you prefer to write notes in Markdown.
- p7zip
    - This will allow us to extract the malicious zip files with passwords!
    - You can install p7zip by running the command `sudo apt-get install p7zip-full`. It is not included in REMnux by default.
- OPTIONAL: Python (Any version >3.9) or the latest version of Java
    - This is optional, but useful for scripting with Ghidra. Ghidra supports custom Python or Java scripts to help with static malware analysis. We will not cover scripting in this guide.

Once you have installed these programs, you’ll be ready to move onto the next step!

### Step 4: Acquire the Malware

While we have internet access, we will want to download .zip files of malware samples from reputable sources. For the purpose of this guide, we will work with one sample of the **Industroyer** category of malware posted on MalwareBazaar. This malware class was created by Sandworm, Russia’s Military Intelligence Unit (Unit 74455). 

To download the Industroyer malware sample, click [here](https://bazaar.abuse.ch/download/ea16cb89129ab062843c84f6c6661750f18592b051549b265aaf834e100cd6fc/). You’ll want to click on the ‘download’ button to start the download process. Also, make sure you’re downloading it to your REMnux virtual machine. 

***Note: DO NOT UNZIP THE FILES YET (unless you want to ruin your host machine!)***

After downloading the Industroyer sample, we’ll want to download a benign malware .zip file sample from [here](https://www.eicar.org/download-anti-malware-testfile/). This will be our testing sample to see if our virtual machine is isolated (in terms of shared memory access) from our host.

### Step 5: Isolate REMnux from the Host

Last but not least, we will want to isolate our virtual machine. Our goal is to remove network access, function sharing, and any shared folders between our virtual machine and our host. It’s critical that these steps are fully completed, as otherwise we are risking our entire device and potentially other devices on the network.

Just as a fun note, [there is malware that can “escape” virtual machines and infect the host.](https://www.techrepublic.com/article/10-new-vm-escape-vulnerabilities-discovered-in-virtualbox/) On VirtualBox, usually malware will attempt to take advantage of a few known vulnerabilities. 

***Note: This is an important step to follow! Failure to follow this step could result in serious damage to your device.*** 

To isolate the REMnux virtual machine:

- Change the `Devices > Shared Clipboard > Disabled` setting to disable shared clipboard access, then click OK.
- Change the `Devices > Drag and Drop > Disabled` setting to disable drag and drop access, then click OK.
- Remove any shared folders under `Devices > Shared Folders` (by default, there are none).
- Check if VirtualBox Guest Additions are enabled by going to performance settings (`Host Key + N`). From there, select the `Runtime Information Tab` and view the Guest Additions information. If the guest additions are not installed, then it should report “Guest Additions: Not Detected”. If these additions have been installed for any reason, you will want to uninstall them. The easiest way to do so, unfortunately, is to uninstall VirtualBox and reinstall it without them.
- Go to `Devices > Network > Network Settings` , then alter the adapter in use (most likely Adapter 1) and change its “Attached to” setting to `Not attached`, then click OK. Here is a picture of this setting for reference:

![malwareguide2.png](img/malwareguide2.png)

To verify that your virtual machine is properly isolated, you’ll first want to test if your virtual machine is not connected to any network. You can do this by simply opening a web browser and checking if you can access the internet.

Next, you’ll want to test if clipboard access has properly been disabled. The easiest way to check is if you can copy something from your virtual machine and paste it to your host machine. 

Last but not least, we will run some sample code that will trigger any anti-virus software installed on our host machine if there is shared memory between the virtual machine and the host machine. You can unzip the file by using `cd name/to/file/location` to get to the file location (replace path with location) using `7z x eicar_com.zip` to unzip the file. 

- If you get to a prompt that asks you to respond with yes, no, skip all, or quit, respond with ‘(s)kip all’.

If any of these checks have failed, go back to the beginning of step 5 and make sure all these settings are correct. *If all of them are set to what they should be, then these checks should pass.* 

### Step 6: Release the Kraken!

Assuming you have set up all the other steps correctly, you should be good to go!

- To unzip the malicious sample code, simply run the command `7z x ea16cb89129ab062843c84f6c6661750f18592b051549b265aaf834e100cd6fc.zip -pinfected`. Remember, the tab key is your friend here (filling in the rest of the file name is super helpful in this case, considering that clipboard access is disabled!).
    - If you get to a prompt that asks you to respond with yes, no, skip all, or quit, respond with ‘(s)kip all’, just like last time!

Now you’ll be ready to perform a static analysis with Ghidra!
